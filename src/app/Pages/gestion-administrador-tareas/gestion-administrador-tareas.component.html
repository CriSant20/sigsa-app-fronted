<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión Sigsa Software</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
  <div class="layout-wrapper">
    <app-navbar></app-navbar>
    <app-menu></app-menu>

    <main class="main-content">
      <section *ngIf="!perfilVisible" class="filter-section">
        <div class="filters">
          <input type="text" placeholder="Buscar tarea..." [(ngModel)]="searchQuery" />
          <select [(ngModel)]="filterState">
            <option value="">Todos los estados</option>
            <option value="En Revisión">En Revisión</option>
            <option value="Aprobada">Aprobada</option>
            <option value="En Progreso">En Progreso</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Rechazada">Rechazada</option>
            <option value="Cancelada">Cancelada</option>
          </select>
          <input type="date" [(ngModel)]="fechaInicio" />
          <input type="date" [(ngModel)]="fechaFin" />
          <button (click)="borrarFiltros()">Borrar Filtros</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Tarea</th>
                <th>Fecha Envio</th>
                <th>Fecha de Entrega</th>
                <th>Estado</th>
                <th>Costo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let tarea of filteredTareas">
                <td>{{ tarea.id }}</td>
                <td>{{ tarea.nombre }}</td>
                <td>{{ tarea.fecha_envio | date:'yyyy-MM-dd' }}</td>
                <td>{{ tarea.fecha_a_realizar }}</td>
                <td>
                  <select [(ngModel)]="tarea.estado" (change)="actualizarEstado(tarea.id ?? 0, tarea.estado || '')">
                    <option [value]="TaskState.EN_REVISION">{{ TaskState.EN_REVISION }}</option>
                    <option [value]="TaskState.APROBADA">{{ TaskState.APROBADA }}</option>
                    <option [value]="TaskState.EN_PROGRESO">{{ TaskState.EN_PROGRESO }}</option>
                    <option [value]="TaskState.FINALIZADO">{{ TaskState.FINALIZADO }}</option>
                    <option [value]="TaskState.RECHAZADA">{{ TaskState.RECHAZADA }}</option>
                    <option [value]="TaskState.CANCELADA">{{ TaskState.CANCELADA }}</option>
                  </select>
                </td>


                <td>{{ tarea.costo || '-' }}</td>
                <td>
                  <div class="actions">
                    <button class="comentario" (click)="abrirChat(tarea, $event)">Comentario</button>
                    <button class="informacion" (click)="mostrarInformacion(tarea, $event)">Información</button>
                    <button class="Comprobante" (click)="mostrarInformacion(tarea, $event)">Comprobante</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Modal de Comentarios -->
      <div class="modal" *ngIf="comentarioVisible">
        <div class="modal-content">
          <button class="close" (click)="cerrarModalComentario()">X</button>
          <h2>Comentarios</h2>

          <div class="comentarios-list">
            <div *ngFor="let comentario of comentarios" class="comentario-item">
              <div class="comentario-header">
                <span class="usuario">{{comentario.usuario?.nombre_usuario}}</span>
                <span class="fecha">{{comentario.fecha_comentario | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="comentario-texto">
                {{comentario.comentario}}
              </div>
            </div>
          </div>

          <div class="nuevo-comentario">
            <textarea [(ngModel)]="nuevoComentario" rows="3" placeholder="Escriba un comentario..."
              name="nuevoComentario"></textarea>
            <button (click)="guardarComentario()" [disabled]="!nuevoComentario.trim()">Enviar</button>
          </div>
        </div>
      </div>
      <!-- Modal de Información -->
      <div class="modal" *ngIf="informacionVisible">
        <div class="modal-content">
          <button class="close" (click)="cerrarModalInformacion()">X</button>
          <h2>Información de la Tarea</h2>
          <div class="tarea-datos">
            <div><strong>Nombre:</strong> {{ tareaSeleccionada!.nombre }}</div>
            <div><strong>Fecha Envio:</strong> {{ tareaSeleccionada!.fecha_envio | date:'yyyy-MM-dd' }}</div>
            <div><strong>Fecha Entrega:</strong> {{ tareaSeleccionada!.fecha_a_realizar}}</div>
            <div><strong>Fecha Realizada:</strong> {{ tareaSeleccionada!.fecha_realizada || 'Aun no se ha realizado'}}
            </div>

            <div><strong>Estado:</strong> {{ tareaSeleccionada!.estado }}</div>
            <div><strong>Rubrica de la tarea:</strong> {{ tareaSeleccionada!.rubrica }}</div>
            <div><strong>Indicaciones de la tarea:</strong> {{ tareaSeleccionada!.indicaciones }}</div>
            <iframe [src]="getSafeUrl(tareaSeleccionada?.adjunto_url || '')" width="100%" height="600px"></iframe>
          </div>
        </div>
      </div>
      <footer>
        <app-footer></app-footer>
      </footer>
    </main>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>